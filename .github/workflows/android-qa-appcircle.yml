name: Android QA - Appcircle

on:
  workflow_dispatch:

jobs:
  android_qa:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true

      - name: Decode keystore
        run: |
          echo "${{ secrets.ANDROID_KEYSTORE_B64 }}" | base64 -d > android/app/qa.keystore

      - name: Make gradle executable
        run: chmod +x android/gradlew

      - name: Configure signing (gradle.properties)
        run: |
          cat >> android/gradle.properties <<EOF
          MYAPP_UPLOAD_STORE_FILE=qa.keystore
          MYAPP_UPLOAD_STORE_PASSWORD=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          MYAPP_UPLOAD_KEY_ALIAS=${{ secrets.ANDROID_KEY_ALIAS }}
          MYAPP_UPLOAD_KEY_PASSWORD=${{ secrets.ANDROID_KEY_PASSWORD }}
          EOF

      - name: Build APK with fastlane (CLI)
        run: bundle exec fastlane android qa

      - name: Generate Appcircle PAT
        env:
          APPCIRCLE_PERSONAL_ACCESS_KEY: ${{ secrets.APPCIRCLE_PERSONAL_ACCESS_KEY }}
        run: |
          PAT_JSON=$(curl -sS -X POST "https://auth.appcircle.io/auth/v3/token" \
            -H "accept: application/json" \
            -H "Content-Type: application/x-www-form-urlencoded" \
            --data-urlencode "personalAccessKey=${APPCIRCLE_PERSONAL_ACCESS_KEY}")
          TOKEN=$(echo "$PAT_JSON" | jq -r '.token // .access_token // empty')
          test -n "$TOKEN" || (echo "Failed to extract PAT token" && exit 1)
          echo "AC_PERSONAL_API_TOKEN=$TOKEN" >> $GITHUB_ENV

      - name: Upload to Appcircle Testing Distribution
        uses: appcircleio/appcircle-testing-distribution-githubaction@v0.0.3
        with:
          personalAPIToken: ${{ env.AC_PERSONAL_API_TOKEN }}
          profileName: ${{ secrets.APPCIRCLE_PROFILE_NAME }}
          createProfileIfNotExists: true
          appPath: android/app/build/outputs/apk/release/app-release.apk
          message: 'QA build ${{ github.ref_name }} @ ${{ github.sha }}'
